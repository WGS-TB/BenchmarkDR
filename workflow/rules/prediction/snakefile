configfile: "config.yaml"

path_data = config["PATH_DATA"] + "/"
# output_dir = path_data

rule build_model:
    input:
        conf="workflow/rules/prediction/models_conf.yml"
    output:
        path_data + "{bacterium}/prediction/models/{method}.joblib"
    conda:
        "../../envs/prediction/env.yml"
    shell:
        "python workflow/scripts/prediction/build_model.py --config {input.conf} --model-name {wildcards.method} --outfile {output}"

rule evaluation:
    input:
        data=str("data/gene_data/gene_data_full.csv"),
        #data=str(path_data + "{bacterium}/representation/gene_presence_absence/0_matrix.csv"),
        label=str("data/gene_data/label_{drug}.csv"),
        #label="data/gene_data/test_bacterium_label.csv",
        model=path_data + "{bacterium}/prediction/models/{method}.joblib",
        conf="workflow/rules/prediction/models_conf.yml"
    params:
        cv=config["OPTIMIZATION"]
    output:
        str(path_data + "{bacterium}/prediction/results/{method}-{drug}.csv")
    conda:
        "../../envs/prediction/env.yml"
    shell:
        "python workflow/scripts/prediction/evaluation.py --data {input.data} --label {input.label} --config {input.conf} --model {wildcards.method} --modelfile {input.model} --optimize {params.cv} --outfile {output}"

rule aggregate_summary:
    input:
        expand(path_data + "{bacterium}/prediction/results/{method}-{drug}.csv",
            method=config["METHODS"], drug=config["DRUGS"], allow_missing=True)
    output:
        str(path_data + "{bacterium}/prediction/summary.csv")
    shell:
        "python workflow/scripts/prediction/aggregate.py --data {input} --outfile {output}"

# TODO rule visual_report: